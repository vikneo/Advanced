# Очереди задач (module 22)

*Разбираемся с Celery и брокером Redis*

* Module [collections](https://docs.python.org/3/library/collections.html) официальная документация
* [Очереди задач](#очереди-задач)
* [Установка и запуск](#установка-и-запуск)
* Отправка писем

## Установка и запуск

*Подразумевается, что у вас установлен [додкер](../module_09_docker/Docker.md)*

* [Redis](#подключаем-redis)
* [Celery](#подключаем-celery)

### Подключаем Redis

Для работы с **Celery** понадобится установить брокер сообщений.<br> 
**Брокер сообщений** — это специальная служба, к которой подключаются отправители и получатели данных. В роли брокера могут выступать *Redis, RabbitMQ и Amazon SQS*. В качестве примера возьмём **Redis**.

* Загружаем образ Redis
```html
docker pull redis
```
Будет загружена последняя версия образа **Redis** из Docker Hub и сохранит его локально на вашей машине

* Запускаем контейнер **Redis**
```html
    # Первый запуск контейнера
docker run -p 6379:6379 --name my-redis -d redis

    # Для последующих запусков
    # запустить контейнер
docker start my-redis

    Остановить контейнер
docker stop my-redis
```
Эта команда запускает новый контейнер **Redis** в фоновом режиме и назначает ему имя *my-redis*.<br> 
Флаг **-d** указывает Docker запустить контейнер в фоновом режиме.<br> 
Флаг **-p** прокидывает порт 6379 из контейнера на порт 6379 локальной машины

* Команда для просмотра запущенных контейнеров
```html
docker ps
```
Вы должны увидеть контейнер Redis с именем my-redis в списке

### Подключаем Celery

* Для установки Celery выполните команду
```html
    # через pip
pip install celery[redis]==5.3.1

    # с помощью poetry
poetry add celeri[redis]
```
После установки **Celery** вы можете создать файл tasks.py, в котором будет содержаться код для ваших задач

* Запуск **Celery**
    * синтаксис
    ```html
    celery -A tasks worker

    # -А - Указывает имя приложения
    # task - указывается имя модуля где описаны задачи
    # worker - запускает процесс

    # Например:
    --------------------------------------------------
    work_dir
      |
      |----celery_tasks.py
      |               |------celery = Celery()
      |----app.py
    --------------------------------------------------

    from celery import Celery

    celery = Celery(
       'tasks',
       broker='redis://localhost:6379/0',
       backend='redis://localhost:6379/0'
    )
    @celery.task
    def add(x, y):
       return x + y
    ```
    **tasks** — название нашего Celery-приложения.<br>
    **broker** — URL брокера сообщений. <br>
    **backend** — URL хранилища результатов; можно указать URL брокера. 

    * Команда  ля запуска будет следущая
    ```html
    celery -A celery_tasks worker

    # или
    celery -A celery_tasks:celery worker
    ```

## Очереди задач

*Памятка*
* Для остановки процессов можно воспользоваться командой:
  * Процесс закончит текущую задачу перед завершением. 
  ```html
  ps auxww | grep 'celery worker' | awk '{print $2}' | xargs kill
  ```
  * Процесс будет закрыт не дожидаясь окончания выполнения задач
  ```html
  ps auxww | grep 'celery worker' | awk '{print $2}' | xargs kill -9
  ```

* Класс **[deque()](https://docs-python.ru/standart-library/modul-collections-python/klass-deque-modulja-collections/)** модуля *collections* на русском языке

  #### Коротко:
  * Класс **deque()** модуля *collections* возвращает новый объект deque(), 
  инициализированный слева направо данными из итерируемой последовательности *iterable*.
  При создании объекта очереди класс использует метод **dq.append()** для добавления элементов из итерации *iterable*. 
  Если итерация не указана, новая очередь **deque()** будет пуста.

  #### Синтаксис:
  ```html
    from collections import deque
    dq = deque([iterable[, maxlen]])
  ```
  #### Параметры:
    * **iterable** - итерируемая последовательность,
    * **maxlen (int)** - максимальное кол-во хранимых записей.

  #### Возвращаемое значение:
    * новый объект Deque.

### Цепочки задач

**Цепочка задач** - это механизм для последовательного запуска задач, где результат одной задачи передается в качестве аргумента следующей.<br>

## To be continued >>>